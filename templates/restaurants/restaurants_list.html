{% extends 'base.html' %}

{% block content %}
    {% include "mixins/address_display.html" %}

    <div id="contents">
        <div class="flex px-64 py-2 mb-3 border-b border-gray-500">
            <ul class="flex justify-between items-center w-2/3">
                <li v-on:click="ChangeUrl(group.id), fetch_all_restaurants(group.id)" v-for="group in groups" v-if="group.id != 1" class="px-2">
                    <div class="border-b-2 border-white hover:border-black">
                       <span class="text-black cursor-pointer">[[group.name]]</span>
                    </div>
                </li>
            </ul>
            <div class="flex justify-end w-1/3 h-full">
                <input v-on:keyup.enter="search_restaurants()" v-model:trim="name" class="p-0 pl-2 w-3/4 h-8 text-sm" type="text" placeholder="음식점 또는 메뉴로 검색">
            </div>
        </div>

        <div class="flex flex-wrap px-64 text mb-3">
            <div class="w-full flex flex-wrap">
                <a v-for="restaurant in restaurants" class="w-1/2 h-32" v-bind:href="'../../restaurants/' + restaurant.id + '/'">
                    <div class="flex p-3 border border-gray-400">
                        <div class="w-24 h-24 bg-cover bg-center" v-bind:style="{'background-image': 'url(../../media/' + restaurant.photo + ')' }"></div>    
                        <div class="flex flex-col p-3 ml-3">
                            <span class="text-black">[[restaurant.name]]</span>
                            <span class="mt-3 text-black text-xs">배달요금 : [[restaurant.delivery_cost]]원 | 최소주문금액 : [[restaurant.minimum_amount]]원</span>
                        </div>   
                    </div>
                </a>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
<script type="text/javascript">
function ChangeUrl(groupId) {
    console.log("ChangeUrl ID : " + groupId);
    if(typeof(history.pushState) != "undefined") {
        history.pushState(null, null, "../../groups/" + groupId + "/")
    }
    else {
        location.href = "../../groups/" + groupId + "/";
    }
}
</script>
<script>
    // CSRF Token 관련하여 전역변수로 선언
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = 'X-CSRFToken';

    var groupId = 0;
    var vm = new Vue({
        delimiters: ["[[", "]]"],
        el: "#contents",
        data: {
            name: "",
            groups: [],
            restaurants: [],
            group_id: "{{group_id}}",
        },
        created: function () {
            console.log("created()");
            this.fetch_all_groups();
            this.fetch_all_restaurants(groupId);
        },
        methods: {
            fetch_all_groups: function () {
                var vm = this;

                axios.get("/api/groups-bar/")
                    .then(function (res) {
                        console.log("res.data", res.data);
                        vm.groups = res.data;
                        
                    })
                    .catch(function (err) {
                        console.log("GET ERR", err);
                    })
            },
            fetch_all_restaurants: function (groupId) {
                var vm = this;
                if (groupId == 0) {
                    groupId = {{group_id}};
                }
                
                axios.get("/api/" + groupId + "/restaurants-list/")
                    .then(function (res) {
                        console.log("res.data", res.data);
                        vm.restaurants = res.data;
                        console.log("vm.restaurants", vm.restaurants);
                    })
                    .catch(function (err) {
                        console.log("GET ERR", err);
                    })
            },
            search_restaurants: function () {
                var vm = this;
                var postData = {name: this.name};
                console.log(postData);
                axios.post("/api/search-restaurants/", postData)
                    .then(function (res) {
                        console.log("post res.data", res.data);
                        vm.restaurants = res.data;
                        console.log("post vm.restaurants", vm.restaurants);
                    })
                    .catch(function (err) {
                        console.log("POST ERR", err)
                    })
                this.name = "";
            },
        },
    })
</script>
{% endblock javascript %}
